generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgcrypto]
}

// ==================== MULTI-TENANT ====================

model Organization {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  slug      String   @unique
  plan      PlanType @default(FREE)
  settings  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users             User[]
  teams             Team[]
  channels          Channel[]
  contacts          Contact[]
  conversations     Conversation[]
  tags              Tag[]
  customFields      CustomFieldDefinition[]
  automations       Automation[]
  quickReplies      QuickReply[]
  scheduledMessages ScheduledMessage[]
  messageSequences  MessageSequence[]
  broadcasts        Broadcast[]
  webhooks          Webhook[]
  auditLogs         AuditLog[]
  knowledgeItems    KnowledgeItem[]
  aiConfig          AIConfig?

  @@map("organizations")
}

enum PlanType {
  FREE
  STARTER
  GROWTH
  ENTERPRISE
}

// ==================== USER & AUTH ====================

model User {
  id                 String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId     String            @map("organization_id") @db.Uuid
  email              String
  passwordHash       String            @map("password_hash")
  firstName          String            @map("first_name")
  lastName           String            @map("last_name")
  avatarUrl          String?           @map("avatar_url")
  role               UserRole          @default(AGENT)
  status             UserStatus        @default(ACTIVE)
  availabilityStatus AgentAvailability @default(OFFLINE) @map("availability_status")
  lastActiveAt       DateTime?         @map("last_active_at")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  // Relations
  organization            Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  teamMembers             TeamMember[]
  refreshTokens           RefreshToken[]
  assignedChats           Conversation[]      @relation("AssignedAgent")
  activeConversations     Conversation[]      @relation("ActiveAgent")
  conversationAssignments ConversationAgent[]
  messages                Message[]           @relation("SentByUser")
  auditLogs               AuditLog[]
  conversationNotes       ConversationNote[]  @relation("ConversationNotes")
  scheduledMessages       ScheduledMessage[]

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([email])
  @@index([availabilityStatus])
  @@map("users")
}

enum UserRole {
  OWNER
  ADMIN
  SUPERVISOR
  AGENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum AgentAvailability {
  ONLINE
  AWAY
  BUSY
  OFFLINE
}

model RefreshToken {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ==================== TEAM MANAGEMENT ====================

model Team {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String
  description    String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members      TeamMember[]
  channels     TeamChannel[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("teams")
}

model TeamMember {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  teamId    String   @map("team_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  isLeader  Boolean  @default(false) @map("is_leader")
  createdAt DateTime @default(now()) @map("created_at")

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

model TeamChannel {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  teamId    String   @map("team_id") @db.Uuid
  channelId String   @map("channel_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  team    Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([teamId, channelId])
  @@map("team_channels")
}

// ==================== CHANNELS (Multi-Provider) ====================

model Channel {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId  String        @map("organization_id") @db.Uuid
  type            ChannelType
  name            String
  identifier      String
  status          ChannelStatus @default(DISCONNECTED)
  config          Json          @default("{}")
  hasInitialSync  Boolean       @default(false) @map("has_initial_sync")
  // Sync progress tracking - enables resume from interruption
  syncProgress    Int           @default(0) @map("sync_progress") // 0-100%
  syncStartedAt   DateTime?     @map("sync_started_at")
  lastSyncAt      DateTime?     @map("last_sync_at")
  lastConnectedAt DateTime?     @map("last_connected_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  authState         WhatsAppAuthState?
  conversations     Conversation[]
  messages          Message[]
  broadcastChannels BroadcastChannel[]
  teamChannels      TeamChannel[]

  @@unique([organizationId, type, identifier])
  @@index([organizationId])
  @@index([type])
  @@map("channels")
}

enum ChannelType {
  WHATSAPP
  TIKTOK
  INSTAGRAM
  TELEGRAM
  EMAIL
}

enum ChannelStatus {
  CONNECTED
  DISCONNECTED
  CONNECTING
  ERROR
  BANNED
}

// ==================== WHATSAPP SESSION (Production Auth State) ====================

model WhatsAppAuthState {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  channelId String   @unique @map("channel_id") @db.Uuid
  creds     Bytes
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  channel  Channel           @relation(fields: [channelId], references: [id], onDelete: Cascade)
  syncKeys WhatsAppSyncKey[]

  @@map("whatsapp_auth_states")
}

model WhatsAppSyncKey {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  authStateId String   @map("auth_state_id") @db.Uuid
  keyId       String   @map("key_id")
  keyData     Bytes    @map("key_data")
  createdAt   DateTime @default(now()) @map("created_at")

  authState WhatsAppAuthState @relation(fields: [authStateId], references: [id], onDelete: Cascade)

  @@unique([authStateId, keyId])
  @@index([authStateId])
  @@map("whatsapp_sync_keys")
}

// ==================== CONTACTS & CRM ====================

model Contact {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String      @map("organization_id") @db.Uuid
  identifier     String
  channelType    ChannelType @map("channel_type")
  isGroup        Boolean     @default(false) @map("is_group")
  displayName    String?     @map("display_name")
  firstName      String?     @map("first_name")
  lastName       String?     @map("last_name")
  email          String?
  avatarUrl      String?     @map("avatar_url")
  metadata       Json        @default("{}")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tags                ContactTag[]
  customFields        ContactCustomField[]
  conversations       Conversation[]
  broadcastRecipients BroadcastRecipient[]

  @@unique([organizationId, channelType, identifier])
  @@index([organizationId])
  @@index([identifier])
  @@map("contacts")
}

model Tag {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String
  color          String   @default("#6366f1")
  createdAt      DateTime @default(now()) @map("created_at")

  organization  Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contacts      ContactTag[]
  conversations ConversationTag[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("tags")
}

model ContactTag {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contactId String   @map("contact_id") @db.Uuid
  tagId     String   @map("tag_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([contactId, tagId])
  @@map("contact_tags")
}

model CustomFieldDefinition {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String          @map("organization_id") @db.Uuid
  name           String
  key            String
  type           CustomFieldType
  options        Json?
  isRequired     Boolean         @default(false) @map("is_required")
  createdAt      DateTime        @default(now()) @map("created_at")

  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  values       ContactCustomField[]

  @@unique([organizationId, key])
  @@map("custom_field_definitions")
}

enum CustomFieldType {
  TEXT
  NUMBER
  DATE
  SELECT
  MULTI_SELECT
  BOOLEAN
  URL
}

model ContactCustomField {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contactId    String   @map("contact_id") @db.Uuid
  definitionId String   @map("definition_id") @db.Uuid
  value        Json
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  contact    Contact               @relation(fields: [contactId], references: [id], onDelete: Cascade)
  definition CustomFieldDefinition @relation(fields: [definitionId], references: [id], onDelete: Cascade)

  @@unique([contactId, definitionId])
  @@map("contact_custom_fields")
}

// ==================== CONVERSATIONS & MESSAGES ====================

model Conversation {
  id               String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId   String             @map("organization_id") @db.Uuid
  channelId        String             @map("channel_id") @db.Uuid
  contactId        String             @map("contact_id") @db.Uuid
  assignedUserId   String?            @map("assigned_user_id") @db.Uuid
  activeAgentId    String?            @map("active_agent_id") @db.Uuid
  activeAgentSince DateTime?          @map("active_agent_since")
  status           ConversationStatus @default(OPEN)
  priority         Priority           @default(NORMAL)
  lastMessageAt    DateTime?          @map("last_message_at")
  unreadCount      Int                @default(0) @map("unread_count")
  closedAt         DateTime?          @map("closed_at")
  isPinned         Boolean            @default(false) @map("is_pinned")
  pinnedAt         DateTime?          @map("pinned_at")
  // OrderOps integration
  orderOpsOrderId   Int?              @map("orderops_order_id")
  orderOpsOrderCode String?           @map("orderops_order_code")
  orderOpsLinkedAt  DateTime?         @map("orderops_linked_at")
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")

  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  channel            Channel             @relation(fields: [channelId], references: [id], onDelete: Cascade)
  contact            Contact             @relation(fields: [contactId], references: [id], onDelete: Cascade)
  assignedUser       User?               @relation("AssignedAgent", fields: [assignedUserId], references: [id])
  activeAgent        User?               @relation("ActiveAgent", fields: [activeAgentId], references: [id])
  messages           Message[]
  agents             ConversationAgent[]
  tags               ConversationTag[]
  notes              ConversationNote[]
  scheduledMessages  ScheduledMessage[]
  sequenceExecutions SequenceExecution[]

  @@unique([channelId, contactId])
  @@index([organizationId])
  @@index([assignedUserId])
  @@index([activeAgentId])
  @@index([status])
  @@index([lastMessageAt(sort: Desc)])
  @@index([isPinned, pinnedAt(sort: Desc)])
  @@index([orderOpsOrderId])
  @@map("conversations")
}

// Multi-agent assignment for collaborative conversations
model ConversationAgent {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversationId String   @map("conversation_id") @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  isPrimary      Boolean  @default(false) @map("is_primary")
  assignedAt     DateTime @default(now()) @map("assigned_at")
  assignedById   String?  @map("assigned_by_id") @db.Uuid

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
  @@map("conversation_agents")
}

// Tags for conversations (separate from contact tags)
model ConversationTag {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversationId String   @map("conversation_id") @db.Uuid
  tagId          String   @map("tag_id") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  tag          Tag          @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([conversationId, tagId])
  @@index([conversationId])
  @@map("conversation_tags")
}

// Internal notes for conversations (not sent to customer)
model ConversationNote {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversationId String   @map("conversation_id") @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  content        String
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation("ConversationNotes", fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("conversation_notes")
}

enum ConversationStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model Message {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversationId String           @map("conversation_id") @db.Uuid
  channelId      String           @map("channel_id") @db.Uuid
  externalId     String?          @map("external_id")
  direction      MessageDirection
  type           MessageType
  content        Json
  status         MessageStatus    @default(PENDING)
  sentByUserId   String?          @map("sent_by_user_id") @db.Uuid
  sentAt         DateTime?        @map("sent_at")
  deliveredAt    DateTime?        @map("delivered_at")
  readAt         DateTime?        @map("read_at")
  failedReason   String?          @map("failed_reason")
  metadata       Json             @default("{}")
  isAIGenerated  Boolean          @default(false) @map("is_ai_generated")
  createdAt      DateTime         @default(now()) @map("created_at")

  conversation Conversation        @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  channel      Channel             @relation(fields: [channelId], references: [id], onDelete: Cascade)
  sentByUser   User?               @relation("SentByUser", fields: [sentByUserId], references: [id])
  attachments  MessageAttachment[]

  @@unique([channelId, externalId])  // Composite unique for fast idempotency check + enables findUnique
  @@index([conversationId])
  @@index([createdAt(sort: Desc)])
  @@map("messages")
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  STICKER
  LOCATION
  CONTACT
  TEMPLATE
  INTERACTIVE
  REACTION
  SYSTEM
}

enum MessageStatus {
  PENDING
  QUEUED
  SENT
  DELIVERED
  READ
  FAILED
}

model MessageAttachment {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  messageId String   @map("message_id") @db.Uuid
  type      String
  url       String
  fileName  String?  @map("file_name")
  mimeType  String?  @map("mime_type")
  size      Int?
  metadata  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("message_attachments")
}

// ==================== AUTOMATION ====================

model Automation {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  name           String
  description    String?
  trigger        Json
  conditions     Json      @default("[]")
  actions        Json
  isActive       Boolean   @default(true) @map("is_active")
  priority       Int       @default(0)
  executionCount Int       @default(0) @map("execution_count")
  lastExecutedAt DateTime? @map("last_executed_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  logs         AutomationLog[]

  @@index([organizationId])
  @@index([isActive])
  @@map("automations")
}

model AutomationLog {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  automationId    String   @map("automation_id") @db.Uuid
  triggeredBy     Json     @map("triggered_by")
  status          String
  executedActions Json     @default("[]") @map("executed_actions")
  errorMessage    String?  @map("error_message")
  executedAt      DateTime @default(now()) @map("executed_at")

  automation Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId])
  @@index([executedAt(sort: Desc)])
  @@map("automation_logs")
}

model QuickReply {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String
  shortcut       String
  content        Json
  category       String?
  usageCount     Int      @default(0) @map("usage_count")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, shortcut])
  @@index([organizationId])
  @@map("quick_replies")
}

// ==================== SCHEDULED MESSAGES ====================

enum ScheduledMessageStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

model ScheduledMessage {
  id             String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String                 @map("organization_id") @db.Uuid
  conversationId String                 @map("conversation_id") @db.Uuid
  createdById    String                 @map("created_by_id") @db.Uuid
  content        Json // { text?: string, mediaType?: string, mediaUrl?: string }
  scheduledAt    DateTime               @map("scheduled_at")
  sentAt         DateTime?              @map("sent_at")
  status         ScheduledMessageStatus @default(PENDING)
  errorMessage   String?                @map("error_message")
  createdAt      DateTime               @default(now()) @map("created_at")
  updatedAt      DateTime               @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  createdBy    User         @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([conversationId])
  @@index([scheduledAt])
  @@index([status])
  @@map("scheduled_messages")
}

// ==================== MESSAGE SEQUENCES ====================

enum MessageSequenceStatus {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
}

enum SequenceStepType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  DELAY
}

model MessageSequence {
  id             String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String                @map("organization_id") @db.Uuid
  name           String
  shortcut       String?               // Optional shortcut for /command access (e.g., "welcome" for /welcome)
  description    String?
  status         MessageSequenceStatus @default(DRAFT)
  triggerType    String                @default("manual") @map("trigger_type") // manual, keyword, tag_added, etc.
  triggerConfig  Json?                 @map("trigger_config") // { keyword: "hello", tagId: "..." }
  usageCount     Int                   @default(0) @map("usage_count")
  createdAt      DateTime              @default(now()) @map("created_at")
  updatedAt      DateTime              @updatedAt @map("updated_at")

  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  steps        MessageSequenceStep[]
  executions   SequenceExecution[]

  @@unique([organizationId, shortcut])
  @@index([organizationId])
  @@index([status])
  @@map("message_sequences")
}

model MessageSequenceStep {
  id         String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sequenceId String           @map("sequence_id") @db.Uuid
  order      Int // Step order in sequence
  type       SequenceStepType
  content    Json // { text?: string, mediaUrl?: string, mediaFilename?: string, delayMinutes?: number }
  createdAt  DateTime         @default(now()) @map("created_at")
  updatedAt  DateTime         @updatedAt @map("updated_at")

  sequence MessageSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@index([sequenceId])
  @@map("message_sequence_steps")
}

model SequenceExecution {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sequenceId     String    @map("sequence_id") @db.Uuid
  conversationId String    @map("conversation_id") @db.Uuid
  currentStep    Int       @default(0) @map("current_step")
  status         String    @default("running") // scheduled, running, completed, stopped, failed
  scheduledAt    DateTime? @map("scheduled_at") // When to START the sequence (null = immediate)
  startedAt      DateTime  @default(now()) @map("started_at")
  completedAt    DateTime? @map("completed_at")
  nextStepAt     DateTime? @map("next_step_at") // When to execute next step (for delays)
  errorMessage   String?   @map("error_message")

  sequence     MessageSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  conversation Conversation    @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([sequenceId])
  @@index([conversationId])
  @@index([status])
  @@index([scheduledAt])
  @@index([nextStepAt])
  @@map("sequence_executions")
}

// ==================== BROADCAST ====================

model Broadcast {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId  String          @map("organization_id") @db.Uuid
  name            String
  content         Json
  scheduledAt     DateTime?       @map("scheduled_at")
  startedAt       DateTime?       @map("started_at")
  completedAt     DateTime?       @map("completed_at")
  status          BroadcastStatus @default(DRAFT)
  totalRecipients Int             @default(0) @map("total_recipients")
  sentCount       Int             @default(0) @map("sent_count")
  deliveredCount  Int             @default(0) @map("delivered_count")
  readCount       Int             @default(0) @map("read_count")
  failedCount     Int             @default(0) @map("failed_count")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  channels     BroadcastChannel[]
  recipients   BroadcastRecipient[]

  @@index([organizationId])
  @@index([status])
  @@map("broadcasts")
}

enum BroadcastStatus {
  DRAFT
  SCHEDULED
  PROCESSING
  COMPLETED
  CANCELLED
  FAILED
}

model BroadcastChannel {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  broadcastId String   @map("broadcast_id") @db.Uuid
  channelId   String   @map("channel_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")

  broadcast Broadcast @relation(fields: [broadcastId], references: [id], onDelete: Cascade)
  channel   Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([broadcastId, channelId])
  @@map("broadcast_channels")
}

model BroadcastRecipient {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  broadcastId String        @map("broadcast_id") @db.Uuid
  contactId   String        @map("contact_id") @db.Uuid
  status      MessageStatus @default(PENDING)
  messageId   String?       @map("message_id")
  sentAt      DateTime?     @map("sent_at")
  deliveredAt DateTime?     @map("delivered_at")
  readAt      DateTime?     @map("read_at")
  failedAt    DateTime?     @map("failed_at")
  errorReason String?       @map("error_reason")

  broadcast Broadcast @relation(fields: [broadcastId], references: [id], onDelete: Cascade)
  contact   Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([broadcastId, contactId])
  @@index([broadcastId])
  @@index([status])
  @@map("broadcast_recipients")
}

// ==================== WEBHOOKS ====================

model Webhook {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String
  url            String
  secret         String
  events         String[]
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deliveries   WebhookDelivery[]

  @@index([organizationId])
  @@map("webhooks")
}

model WebhookDelivery {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  webhookId   String   @map("webhook_id") @db.Uuid
  event       String
  payload     Json
  status      Int
  response    String?
  attempts    Int      @default(1)
  deliveredAt DateTime @default(now()) @map("delivered_at")

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([deliveredAt(sort: Desc)])
  @@map("webhook_deliveries")
}

// ==================== ANALYTICS ====================

model AnalyticsDaily {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  date           DateTime @db.Date
  channelId      String?  @map("channel_id") @db.Uuid
  userId         String?  @map("user_id") @db.Uuid

  messagesIn          Int  @default(0) @map("messages_in")
  messagesOut         Int  @default(0) @map("messages_out")
  conversationsOpened Int  @default(0) @map("conversations_opened")
  conversationsClosed Int  @default(0) @map("conversations_closed")
  avgResponseTimeMs   Int? @map("avg_response_time_ms")
  avgResolutionTimeMs Int? @map("avg_resolution_time_ms")
  newContacts         Int  @default(0) @map("new_contacts")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([organizationId, date, channelId, userId])
  @@index([organizationId, date])
  @@map("analytics_daily")
}

// ==================== AUDIT LOG ====================

model AuditLog {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  userId         String?  @map("user_id") @db.Uuid
  action         String
  entityType     String   @map("entity_type")
  entityId       String?  @map("entity_id") @db.Uuid
  oldValues      Json?    @map("old_values")
  newValues      Json?    @map("new_values")
  ipAddress      String?  @map("ip_address")
  userAgent      String?  @map("user_agent")
  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id])

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

// ==================== AI KNOWLEDGE BANK ====================

model KnowledgeItem {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String        @map("organization_id") @db.Uuid
  type           KnowledgeType
  title          String
  content        String        @db.Text
  keywords       String[]
  category       String?
  isActive       Boolean       @default(true) @map("is_active")
  priority       Int           @default(0)
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([type])
  @@index([isActive])
  @@map("knowledge_items")
}

enum KnowledgeType {
  FAQ
  PRODUCT
  POLICY
  GENERAL
}

model AIConfig {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId    String   @unique @map("organization_id") @db.Uuid

  // OpenAI Settings
  openaiApiKey      String?  @map("openai_api_key")
  model             String   @default("gpt-4o-mini")

  // Auto-Reply Settings
  isEnabled         Boolean  @default(false) @map("is_enabled")
  replyToAll        Boolean  @default(false) @map("reply_to_all")
  responseDelayMs   Int      @default(2000) @map("response_delay_ms")

  // Business Hours (Malaysia Time UTC+8)
  businessHoursOnly Boolean  @default(false) @map("business_hours_only")
  businessStart     String?  @map("business_start")
  businessEnd       String?  @map("business_end")
  offHoursMessage   String?  @map("off_hours_message")

  // Handoff Settings
  handoffKeywords   String[] @map("handoff_keywords")
  handoffMessage    String?  @map("handoff_message")

  // Prompt Settings
  systemPrompt      String?  @map("system_prompt") @db.Text
  companyName       String?  @map("company_name")

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("ai_configs")
}
